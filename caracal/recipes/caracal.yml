#!/usr/bin/env -S stimela run
_include:
  - caracal-flag.yml
  - caracal-selfcal.yml
  - caracal-ddcal.yml
  - caracal-test-sets.yml[optional,warn]
  - caracal-observation-sets.yml[optional,warn]
_include_post:
  - caracal-srun.yml

caracal-pointings:
  name: "CARACAL pointing loop"
  info: "Process each pointing of the observation separately"

  for_loop:
    var: ms
    over: ms-pointings
    display_status: "{var}={value} {index1}/{total}"

  inputs:
    _include: caracal-schema.yml

  steps:
    flagging:
      recipe: caracal-flag
      skip: =not recipe.flag-enable
      params:
        dir-out-base: =recipe.dir-out-base
        ms: =recipe.ms
    2gc-reductions:
      recipe: caracal-selfcal
      skip: =not recipe.selfcal-enable
      params:
        dir-out-base: =recipe.dir-out-base
        ms: =recipe.ms
    3gc-reductions:
      recipe: caracal-ddcal
      params:
        dir-out-base: =recipe.dir-out-base
        ms: =recipe.ms

join-pointings:
  name: "CARACAL mosaicking"
  info: "Create a mosaic for the pointings or image similar pointings together"
  inputs:
    _include: caracal-schema.yml
  steps:
    mosaic-image:
      cab: mosaic-queen
      params:
        target_images: ['*MFS-image*']
        input: "{recipe.dir-out-base}/caracal-imaging-{recipe.worker-id}"
        output: "{recipe.dir-out-base}/caracal-imaging-{recipe.worker-id}"
        regrid: True
        name: CARACAL
