schema_version: 1.1.0

general:
  prefix: mypipelinerun

getdata:
  dataid: ['']
  extension: ms

obsconf:
  refant: '0'

transform:
  enable: true
  field: calibrators
  label_out: cal
  split_field:
    enable: true
    col: data

prep:
  enable: true
  label_in: cal
  field: calibrators
  specweights:
    enable: true
    mode: uniform

flag:
  enable: true
  field: calibrators
  label_in: cal
  flag_autocorr:
    enable: true
  flag_spw:
    enable: true
    chans: '*:856~880MHz , *:1658~1800MHz, *:1419.8~1421.3MHz'
    ensure_valid: false
  flag_antennas:
    enable: false
    antennas: '0'
  flag_mask:
    enable: true
    mask: meerkat.rfimask.npy
    uvrange: '0~1000'
  flag_rfi:
    enable: true
    flagger: aoflagger
    aoflagger:
      strategy: firstpass_QUV.rfis

crosscal:
  enable: true
  uvrange: '>150'
  label_in: 'cal'
  set_model:
    enable: true
    meerkat_skymodel: true
  primary:
    reuse_existing_gains: true
    order: KGBAKGB
    combine: ["", "", "", null, "","", scan]
    solint: [inf, inf, inf, null, 60s, 60s, inf]
    calmode: [a, ap, ap, null, a, ap, ap] 
    b_fillgaps: 70
    plotgains: true
  secondary:
    order: KGAKF
    apply: B
    combine: ["", "", null, "", ""] 
    solint: [inf, inf, null, inf, inf]
    calmode: [a, ap, null, a, ap] 
    plotgains: true
  apply_cal: 
    applyto: 
      - gcal
      - bpcal

inspect:
  enable: true
  label_in: 'cal'
  label_plot: '1gc'
  field: 'calibrators'
  dirname: crosscal
  real_imag: 
    enable: true
    avgtime: '60'
  amp_phase: 
    enable: true
    avgtime: '60'
  amp_uvwave: 
    enable: true
    avgtime: '60'
  amp_ant: 
    enable: true
    avgtime: '60'
  phase_uvwave: 
    enable: true
    avgtime: '60'
  amp_scan: 
    enable: true
    avgtime: '60'
  shadems:
    enable: true
    default_column: CORRECTED_DATA
    plots_by_field:
      - "-x BASELINE_M -y FREQ -c amp"
      - "-x real  -y imag   -c SCAN_NUMBER --cnum 100"
      - "-x real  -y imag   -c ANTENNA1 --cnum 100"
      - "-x ANTENNA1 -y ANTENNA2 -c SCAN_NUMBER --cnum 100 --aaxis phase --ared std"
      - "-x ANTENNA1 -y ANTENNA2 -c SCAN_NUMBER --cnum 100 --aaxis amp --ared mean"
      - "-x UV    -y amp    -c SCAN_NUMBER --cnum 100"
      - "-x UV    -y amp    -c ANTENNA1 --cnum 64"
      - "-x UV    -y phase  -c ANTENNA1 --cnum 64"
      - "-x FREQ  -y amp    -c SCAN_NUMBER --cnum 100"
      - "-x FREQ  -y amp    -c ANTENNA1 --cnum 64"
      - "-x U     -y V      -c amp"
      - "-x U     -y V      -c phase --cmin -5 --cmax 5"
    plots:
      - "-x real  -y imag   -c SCAN_NUMBER --cnum 100 --col CORRECTED_DATA/MODEL_DATA --iter-field"
      - "-x real  -y imag   -c ANTENNA1 --cnum 100 --col CORRECTED_DATA/MODEL_DATA --iter-field"
#      - '-x FREQ -y phase --ymin -40 --ymax 40 -c SCAN_NUMBER --cnum 100 --field {bpcal} --dir {msbase}-bpcal-byant --iter-ant'
#      - '-x FREQ -y phase --ymin -40 --ymax 40 -c SCAN_NUMBER --cnum 100 --field {gcal} --dir {msbase}-gcal-byant --iter-ant'
#      - '-x FREQ -y phase --ymin -40 --ymax 40 -c ANTENNA1 --cnum 100 --field {all_fields} --dir {msbase}-byscan --iter-scan'
      - '-x FREQ -y amp:I -c SCAN_NUMBER --cnum 100 --cmin 0 --cmax 30 --field {bpcal} --dir {msbase}-bpcal-iamp-byant --iter-ant'
#      - '-x FREQ -y amp:I -c SCAN_NUMBER --cnum 100 --cmin 0 --cmax 8 --field {gcal} --dir {msbase}-gcal-iamp-byant --iter-ant'
#      - '-x FREQ -y amp:I -c ANTENNA1    --cnum 100 --cmin 0 --cmax 30 --field {all_fields} --dir {msbase}-iamp-byscan --iter-scan'
#      - '-x FREQ -y amp:Q -c SCAN_NUMBER --cnum 100 --cmin 0 --cmax 5 --field {bpcal} --dir {msbase}-bpcal-qamp-byant --iter-ant'
#      - '-x FREQ -y amp:Q -c SCAN_NUMBER --cnum 100 --cmin 0 --cmax 5 --field {gcal} --dir {msbase}-gcal-qamp-byant --iter-ant'
#      - '-x FREQ -y amp:Q -c ANTENNA1    --cnum 100 --cmin 0 --cmax 5 --field {all_fields} --dir {msbase}-qamp-byscan --iter-scan'
      - '-x ANTENNA1 -y ANTENNA2 -a CORRECTED_DATA:amp --ared std --cmap pride --dir {msbase}-stdamp-byscan --iter-scan'
      - '-x ANTENNA1 -y ANTENNA2 -a CORRECTED_DATA:phase --ared std --cmap pride --dir {msbase}-stdphase-byscan --iter-scan'
      - '-x FREQ -y SCAN_NUMBER -a CORRECTED_DATA:amp --ared std --cmap pride --dir {msbase}-stdamp-byant --iter-ant'
      - '-x FREQ -y SCAN_NUMBER -a CORRECTED_DATA:phase --ared std --cmap pride --dir {msbase}-stdphase-byant --iter-ant'
      - '-x BASELINE_M -y FREQ --iter-scan -a CORRECTED_DATA:imag --ared std --amin 0 --amax 2 --cmap pride --dir {msbase}-stdimag-byscan'
    ignore_errors: true

transform__2:
  enable: true
  split_field:
    enable: true
    otfcal:
      enable: true
      label_cal: '1gc1'

prep__2:
  enable: true
  label_in: corr
  field: target
  specweights:
    enable: true
    mode: uniform

flag__2:
  enable: true
  field: target
  label_in: corr
  flag_rfi: 
    enable: true
    col: DATA
    flagger: aoflagger
    aoflagger:
      strategy: firstpass_QUV.rfis

mask:
  enable: false
  centre_coord:
    - HH:MM:SS
    - DD:MM:SS
  label_in: corr

selfcal:
  enable: true
  img_npix: 4096
  img_cell: 1.3
  cal_timeslots_chunk: 240
  image:
    enable: true
  calibrate:
    enable: true
    gsols_timeslots: [120]

ddcal:
  enable: false
  label_in: 'corr'
  use_pb: true
  calibrate_dd:
    enable: True
    de_sources_mode: manual
  copy_data:
    enable: true
  image_wsclean:
    enable: true
  transfer_model_dd:
    enable: true

line:
  enable: true
  restfreq: '1.420405752GHz'
  make_cube:
    enable: true
    npix: [1800]
    cell: 2
  mstransform:
    enable: true
    doppler:
      enable: true
      telescope: meerkat
