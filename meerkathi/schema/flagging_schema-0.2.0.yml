type: map
mapping:
  schema_version:
    type: str
    required: true

  flagging:
    desc: Flagging of the data.
    type: map
    mapping:
      enable: 
        desc: Execute flagging of the data.
        type: bool
        required: True
        example: 'False'
      label:
        desc: The label is added to the input .MS file name to define the name of the .MS file that should be flagged, <input>-<label>.ms. Default is an empty string, i.e., the original .MS is flagged.
        type: str
        required: false
        example: ''
        
      autoflag_autocorr_powerspectra:
        desc: Flags antennas based on drifts in the scan average of the auto correlation spectra per field. This doesn't strictly require any calibration. It is also not field structure dependent, since it is just based on the DC of the field. Compares scan to median power of scans per field per channel. Also compares antenna to median of the array per scan per field per channel. This should catch any antenna with severe temperature problems.
        type: map
        mapping:
          enable:
            desc: Enables flagging of antennas based on drifts in the scan average of the auto correlation spectra per field.
            type: bool
            required: False
            example: 'False'
          scan_to_scan_threshold:
            desc: Threshold for flagging in sigma above the rest of the scans per field per channel.
            type: int
            required: False
            example: '3'
          antenna_to_group_threshold: 
            desc: Threshold for flagging in sigma above array median power spectra per scan per field per channel.
            type: int
            required: false
            example: '5'
          column:
            desc: Data column to flag.
            type: str
            required: False
            example: 'DATA'
          fields:
            desc: Fields to flag. Given as 'auto' or comma-seperated keys (keys in gcal, bpcal, target).
            type: str
            required: False
            example: 'auto'
          calibrator_fields: 
            desc: Calibrator fields. Given as 'auto' or comma-seperated keys (keys in gcal, bpcal).
            type: str
            required: False
            example: 'auto'
          threads: 
            desc: Number of threads to use.
            type: int
            required: False
            example: '8'
      flag_autocorr:
        desc: Flag autocorrelations. Through CASA flagdata task.
        type: map
        mapping:
          enable:
            desc: Enables flagging of autocorrelations.
            type: bool
            required: False
            example: 'True'
      quack_flagging:
        desc: Do quack flagging, i.e. flag the begining and/or end chunks of each scan. Again, through FLAGDATA.
        type: map
        mapping:
          enable:
            desc: Enable quack flagging.
            type: bool
            required: False
            example: 'False'
          quackinterval:
            desc: Time interval (in seconds) to flag. 
            type: float
            required: False
            example: '8.'
          quackmode: 
            desc: Quack flagging mode. Either 'beg', which flags scan begining, 'endb', which flags end of the scan, 'end', which flags everything but the first specified seconds of the scan and 'tail' which flags all but the last specified seconds of the scan. 
            type: str
            enum: ["beg", "endb", "end", "tail"]
            required: False
            example: 'beg'
      flag_elevation:
        desc: Flag antennas with pointing elevation outisde the selected range through CASA FLAGDATA.
        type: map
        mapping:
          enable:
            desc: Enable flagging based on pointing elevation.
            type: bool
            required: False
            example: 'False'
          low:
            desc: Lower elevation limit. Antennas pointing at elevation below this value are flagged.
            type: float
            required: False
            example: '0'
          high:
            desc: Upper elevation limit. Antennas pointing at elevation above this value are flagged.
            type: float
            required: False
            example: '90'
      flag_shadow:
        desc: Flag shadowed antennas through the CASA task FLAGDATA.
        type: map
        mapping:
          enable:
            desc: Enables flagging of shadowed antennas.
            type: bool
            required: False
            example: 'False'
          tolerance:
            desc: Amounts of shadow allowed (in metres). Default is 0. A positive number allows antennas to overlap in projection. A negative number forces antennas apart in projection.
            type: float
            required: False
            example: '0.'
          include_full_mk64:
            desc: Consider all MeerKAT-64 antennas in the shadowing calculation even if only a subarray is used. Default is False.
            type: bool
            required: False
            example: 'False'
      flag_spw: 
        desc: Flag spectral windows/channels. Of course, through FLAGDATA.
        type: map
        mapping: 
          enable:
            desc: Enable flagging spectral windows/ channels.
            type: bool
            required: False
            example: 'False'
          channels: 
            desc: Channels to flag. Given as "spectral window index:start channel ~ end channel" e.g. "*:856~880MHz". End channel not inclusive.
            type: str
            required: False
            example: '*:856~880MHz , *:1658~1800MHz, *:1419.8~1421.3MHz'
          ensure_valid_selection:
            desc: Check whether the channel selection returns any data. If it does not FLAGDATA is not executed preventing the pipeline from crashing. This check only works with the following spw formats (multiple, comma-separated selections allowed), "*:firstchan~lastchan"; "firstspw~lastspw:firstchan~lastchan"; "spw:firstchan~lastchan"; "firstchan~lastchan". Channels are assumed to be in frequency (Hz, kHz, MHz, GHz allowed; if no units are given it assumes Hz).
            type: bool
            required: False
            example: 'False'
      
      flag_time: 
        desc: Flag timerange in the data using CASA FLAGDATA task.
        type: map
        mapping: 
          enable: 
            desc: Enabla flagging timeranges.
            type: bool
            required: False
            example: 'False'
          timerange: 
            desc: Timerange to flag. Given in format 'YYYY/MM/DD/HH:MM:SS-YYYY/MM/DD/HH:MM:SS'.
            type: str
            required: False
            example: ''
      
      flag_antennas:
        desc: Flag bad antennas. Or just the ones you have sworn a vendetta against.
        type: map
        mapping:
          enable: 
            desc: Enables flagging of bad antennas. 
            type: bool
            required: False
            example: 'False'
          antennas:
            desc: Antennas to flag. Follows the CASA Flagdata syntax. 
            type: str
            required: False
            example: '0'
          timerange: 
            desc: Timerange to flag. Given in format 'YYYY/MM/DD/HH:MM:SS-YYYY/MM/DD/HH:MM:SS'.
            type: str
            required: False
            example: ''

      flag_scan:
        desc: Flag bad scans. Uses CASA Flagdata task.
        type: map
        mapping: 
          enable:
            desc: Enables flagging of bad scans. 
            type: bool
            required: False
            example: 'False'
          scans: 
            desc: Scans to flag. CASA flagdata syntax.
            type: str
            required: False
            example: '0'

      static_mask:
        desc: Apply static mask to flag out known RFI, Meerkat specific. 
        type: map
        mapping: 
          enable:
            desc: Enables the application of static mask on the data.
            type: bool
            required: False
            example: 'False'
          mask: 
            desc: The mask to apply. 
            type: str
            required: false
            example: 'labelled_rfimask.pickle.npy'
          uvrange:
            desc: UV range to select (CASA style range, e.g. lower~upper) for flagging. Leave blank for entire array.
            type: str
            required: false
            example: ''

      autoflag_rfi:
        desc: Flag RFI using AOFlagger software. 
        type: map
        mapping:   
          enable: 
            desc: Enable RFI flagging with AOFlagger or tricolour (not active yet)
            type: bool
            required: False
            example: 'True'
          flagger:
            desc: Choose flagger for automatic flagging
            type: str
            enum: ["aoflagger", "tricolour"] #TODO(sphe) add casa tfcrop
            required: false
            example: "aoflagger"
          strategy: 
            desc: The AOFlagger strategy file to use.
            type: str
            required: False
            example: 'firstpass_QUV.rfis'
          column: 
            desc: Specify column to flag
            type: str
            required: False
            example: 'DATA'
          fields: 
            desc: comma separated list of (zero-indexed) field ids to process
            type: str
            required: false
            example: 'auto'
          calibrator_fields:
            desc: comma separated list of (zero-indexed) field ids to process
            type: str
            required: false
            example: 'auto'
          bands: 
            desc: comma separated list of (zero-indexed) band ids to process
            type: str
            required: false
            example: 'auto'
          window_backend:
            desc: Visibility and flag data is re-ordered from a MS row ordering into time-frequency windows ordered by baseline. 
            type: str
            enum: ["numpy", "zarr-disk"]
            required: false
            example: "numpy"
          tricolour_calibrator_strat:
            type: str
            required: False
            example: 'mk_rfi_flagging_calibrator_fields_firstpass.yaml'
            

      rfinder:
        desc: A tool to investigate the presence of RFI
        type: map
        mapping:
          enable:
            desc: Enable invsetigation of rfi with rfinder
            type: bool
            required: False
            example: 'False'
          telescope:
            desc: Name of telescope
            type: str
            required: False
            example: 'MeerKAT'
          field:
            desc: Field to get flag stats. Given as a key (key in [gcal, bpcal, target]).
            type: str
            required: False
            example: 'target'
          polarization:
            desc:  Select polarisation e.g. xx, yy, xy, yx, q (also in CAPS)
            type: str
            enum: ['xx', 'XX', 'yy', 'YY', 'xy', 'XY', 'yx', 'YX', 'q', 'Q']
            required: False
            example: 'q'
          spw_enable:
            desc: Enable spw for rebinning
            type: bool
            required: False
            example: 'True'
          spw_width:
            desc: Channel width of rebinned output table (MHz)
            type: int
            required: False
            example: '10'
          time_enable:
            desc: Enable time chunking
            type: bool
            required: False
            example: 'True'
          time_step:
            desc: Time chunks in minutes
            type: int
            required: False
            example: '5'
          movies_in_report:
            desc: Generate movies in a repo
            type: bool
            required: False
            example: 'True'

      flagging_summary:
        desc: Write flagging summary at the end of the pre-calibration flagging. Uses CASA FLAGDATA in "summary" mode.
        type: map
        mapping:
          enable:
            desc: Enables the writing of flagging summary.
            type: bool
            required: false
            example: 'True'

