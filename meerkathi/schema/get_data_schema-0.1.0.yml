type: map
mapping:
  schema_version:
    type: str
    required: true

  get_data:
    type: map
    desc: Download and/or convert/unarchive data so that its in the MS format for further processing
    mapping:
      enable: 
        type: bool
        desc: execute this segment
        required: true
      order: 
        type: int
        required: true
        desc: Workers are executed in ascedning order based on this value.
      dataid:
        seq:
          - type: str
        required: false
        desc: Basename of MS. For MeerKAT data to be downloaded by MeerKATHI, this should be the data ID of the observation
      meerkat_query_available:
        type: map
        desc: query the MeerKAT archive to look for HDF5 files and metadata (but no download yet; this is set further below)
        mapping:
          enable:
            type: bool
            desc: Execute this segment
            required: false
          poll_mode:
            type: str
            enum: ["poll", "override"]
            required: true
            desc: Query the MeerKAT archive to look for HDF5 files and metadata (but no download yet; this is set furher below)
          query_url:
            type: str
            required: false
            desc: MeerKAT Apache Solr server
          required_intents:
            seq:
              - type: str
            desc: These better be here for imaging, otherwise manual intervention is required
          product_type_name:
            type: str
            desc: Change only if you want data not from MeerKAT (e.g., KAT7)
          minimum_observation_duration:
            type: float
            desc: Minimum observation time (in hours)
          product_num_channels:
            type: int
            enum: [4096, 32768]
          when_observed:
            type: str
            desc: Range of dates in the form '[NOW/DAY-7DAYS TO NOW/DAY]'
          description_matches:
            type: str
            desc: Description matches. e.g, '.*'
          required_fields:
            seq:
              - type: str
            desc: Only download data with these fields

      download:
        type: map
        desc: Download data from a remote source
        mapping:
          enable:
            type: bool
            desc: Execute this worker
          download_mode:
            type: str
            enum: ["meerkat", "manual"]
            desc: If manual you can specify your url to, say, NRAO ftp server-hosted file here. MeerKAT is filled automatically
          data_url:
            type: str
            desc: Download data from this URL
          reset:
            type: bool
            desc: Overwrite the data if it already exists

      h5toms:
        type: map
        desc: Convert HDF5 files in data_path to MS files; the latter are written to msdir; also creates a MS.TAR file. (This only works for MeerKAT HDF5 files)
        mapping:
          enable:
            type: bool
            desc: Execute this segment
          tar: 
            type: bool
            desc: Create a tarbal of the converted MS.
          channel_range:
            type: str
            desc: Only exctract channels in this range (0-based, inclusive; comma seperated string)
          full_poll:
            type: bool
            desc: Extract all four correlations instead of only the XX,YY
          flags: 
            type: str
            desc: List of online flags to apply (from 'static,cam,data_lost,ingest_rfi,cal_rfi,predicted_rfi', default is all flags, '' will apply no flags)

      untar:
        desc: Unarchive from MS from a archive file.
        type: map
        mapping:
          enable:
            type: bool
            desc: Execute this segment
          tar_options: 
            type: str
            desc: Options to parse to 'tar' command
      
      combine:
        desc: Virtually concatenate MSs and proceed with the combined MS
        type: map
        mapping:
          enable:
            type: bool
            desc: Execute this section
            required: true
          reset:
            type: bool
            desc: Delete concatenated MS if it exists. Else, proceed with existing MS
            required: true
          tar:
            desc: Create a tarbal of the converted MS
            type: map
            mapping:
              enable: 
                desc: Execute this section
                type: bool
                required: true
              tar_options:
                type: str
                desc: Options to parse to the tar command
                required: true
          untar:
            desc: Unarchive from MS from a archive file.
            type: map
            mapping:
              enable: 
                desc: Execute this section
                type: bool
                required: true
              tar_options:
                type: str
                desc: Options to parse to the tar command
                required: true
